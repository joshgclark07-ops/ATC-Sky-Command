<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ATC Flow Management Platform</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * {box-sizing:border-box;}
    html, body {margin:0;padding:0;height:100%;font-family:'Segoe UI', Arial, sans-serif;background:#0a0a14;color:#fff;}
    
    #container {
      position: relative;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    #header {
      background:#1a1a2e;
      border-bottom:2px solid #00acc1;
      padding:0 30px;
      height: 70px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index: 1000;
    }
    
    #header h1 {
      margin:0;
      font-size:22px;
      color:#00acc1;
      font-weight:700;
    }
    
    #header-subtitle {
      font-size:12px;
      color:#888;
      margin-top:3px;
    }
    
    #header-controls {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    #mode-tabs {
      display: flex;
      gap: 5px;
      background: rgba(15, 15, 35, 0.8);
      padding: 5px;
      border-radius: 8px;
      border: 2px solid #00acc1;
    }
    
    .mode-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #888;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .mode-tab:hover {
      color: #00acc1;
      background: rgba(0, 172, 193, 0.1);
    }
    
    .mode-tab.active {
      background: #00acc1;
      color: #000;
    }
    
    #facility-select select {
      padding:10px;
      font-size:14px;
      background:#0f0f23;
      border:2px solid #00acc1;
      border-radius:6px;
      color:#fff;
    }
    
    #map-container {
      flex: 1;
      position: relative;
    }
    
    #map {
      width:100%;
      height:100%;
    }
    
    .dashboard {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }
    
    .dashboard.active {
      display: block;
      pointer-events: all;
    }
    
    /* Simulation Control Bar - Top Left */
    #sim-control-bar {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(15, 15, 35, 0.95);
      border: 2px solid #00acc1;
      border-radius: 8px;
      padding: 12px 20px;
      z-index: 500;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      pointer-events: all;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .control-btn-large {
      background: #00acc1;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-btn-large:hover {
      background: #00d4e8;
    }
    
    .control-btn-large.playing {
      background: #f44336;
    }
    
    .control-btn-large.playing:hover {
      background: #ff5a4f;
    }
    
    .sim-stat {
      display: flex;
      flex-direction: column;
      padding: 0 15px;
      border-left: 1px solid #00acc1;
    }
    
    .sim-stat:first-of-type {
      border-left: none;
    }
    
    .sim-stat-label {
      font-size: 10px;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 3px;
    }
    
    .sim-stat-value {
      font-size: 18px;
      color: #00acc1;
      font-weight: 700;
    }
    
    .expand-btn {
      background: rgba(0, 172, 193, 0.2);
      border: 1px solid #00acc1;
      color: #00acc1;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    
    .expand-btn:hover {
      background: rgba(0, 172, 193, 0.3);
    }
    
    /* Expanded Sim Controls */
    #sim-controls-expanded {
      position: absolute;
      top: 80px;
      left: 20px;
      width: 320px;
      background: rgba(15, 15, 35, 0.95);
      border: 2px solid #00acc1;
      border-radius: 8px;
      padding: 15px;
      z-index: 499;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      pointer-events: all;
      display: none;
    }
    
    #sim-controls-expanded.visible {
      display: block;
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 5px;
      display: block;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .control-value {
      font-size: 16px;
      color: #00acc1;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #1a1a2e;
      outline: none;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #00acc1;
      cursor: pointer;
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #00acc1;
      cursor: pointer;
      border: none;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      margin-bottom: 8px;
    }
    
    .btn-danger {
      background: #f44336;
      color: #fff;
    }
    
    .btn-danger:hover {
      background: #ff5a4f;
    }
    
    /* Left Panel - Active Traffic */
    #left-panel {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 280px;
      background: rgba(15, 15, 35, 0.95);
      border-right: 2px solid #00acc1;
      overflow-y: auto;
      padding: 15px;
      z-index: 500;
      transition: transform 0.3s ease;
      backdrop-filter: blur(10px);
      pointer-events: all;
    }
    
    #left-panel.collapsed {
      transform: translateX(-280px);
    }
    
    #left-panel-toggle {
      position: absolute;
      right: -35px;
      top: 20px;
      background: #00acc1;
      color: #000;
      border: none;
      padding: 10px 8px;
      cursor: pointer;
      border-radius: 0 6px 6px 0;
      font-size: 16px;
      font-weight: 700;
      z-index: 501;
    }
    
    /* Inbound Alert Box - Top Right */
    #inbound-alert-box {
      position: absolute;
      top: 20px;
      right: 20px;
      min-width: 250px;
      max-width: 350px;
      max-height: 400px;
      background: rgba(15, 15, 35, 0.95);
      border: 2px solid #4caf50;
      border-radius: 8px;
      padding: 12px;
      z-index: 500;
      overflow-y: auto;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      pointer-events: all;
    }
    
    #inbound-alert-box.empty {
      display: none;
    }
    
    /* Conflict Panel - Right Side */
    #conflict-panel {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 350px;
      background: rgba(15, 15, 35, 0.95);
      border-left: 3px solid #f44336;
      overflow-y: auto;
      z-index: 500;
      backdrop-filter: blur(10px);
      box-shadow: -4px 0 20px rgba(0,0,0,0.5);
      pointer-events: all;
      display: flex;
      flex-direction: column;
    }
    
    #conflict-panel.hidden {
      transform: translateX(350px);
      transition: transform 0.3s ease;
    }
    
    #conflict-panel-header {
      background: #f44336;
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid rgba(0,0,0,0.3);
    }
    
    #conflict-panel-header.has-alerts {
      animation: headerPulse 2s infinite;
    }
    
    @keyframes headerPulse {
      0%, 100% { background: #f44336; }
      50% { background: #ff6b60; }
    }
    
    #conflict-panel-title {
      font-size: 16px;
      font-weight: 700;
    }
    
    .panel-toggle-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    
    .panel-toggle-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    #conflict-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    
    .alert-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .alert-count {
      background: rgba(26, 26, 46, 0.6);
      padding: 12px 8px;
      border-radius: 6px;
      text-align: center;
    }
    
    .alert-count-value {
      font-size: 24px;
      font-weight: 700;
    }
    
    .alert-count-value.critical {
      color: #f44336;
    }
    
    .alert-count-value.warning {
      color: #ff9800;
    }
    
    .alert-count-value.caution {
      color: #ffeb3b;
    }
    
    .alert-count-label {
      font-size: 9px;
      color: #888;
      text-transform: uppercase;
      margin-top: 3px;
    }
    
    .panel-section {
      margin-bottom: 15px;
      background: rgba(26, 26, 46, 0.6);
      border-radius: 6px;
      padding: 12px;
    }
    
    .panel-header {
      font-size: 12px;
      font-weight: 700;
      color: #00acc1;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    
    .traffic-item {
      background: rgba(15, 15, 35, 0.8);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      border-left: 3px solid #00acc1;
      font-size: 11px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .traffic-item:hover {
      background: rgba(26, 26, 46, 0.9);
    }
    
    .traffic-item.inbound-item {
      border-left-color: #4caf50;
    }
    
    .traffic-item.outbound-item {
      border-left-color: #00acc1;
    }
    
    .traffic-item.crossing-item {
      border-left-color: #9c27b0;
    }
    
    .traffic-callsign {
      font-size: 13px;
      font-weight: 700;
      color: #00acc1;
    }
    
    .traffic-details {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }
    
    .empty-state {
      text-align: center;
      padding: 15px;
      color: #666;
      font-size: 12px;
      font-style: italic;
    }
    
    .inbound-header {
      font-size: 14px;
      font-weight: 700;
      color: #4caf50;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .inbound-count {
      background: #4caf50;
      color: #000;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
    }
    
    .alert-item {
      background: rgba(15, 15, 35, 0.8);
      padding: 12px;
      margin: 10px 0;
      border-radius: 6px;
      border-left: 4px solid #f44336;
      font-size: 12px;
    }
    
    .alert-item.critical {
      border-left-color: #f44336;
      background: rgba(61, 10, 10, 0.8);
    }
    
    .alert-item.warning {
      border-left-color: #ff9800;
      background: rgba(61, 42, 10, 0.8);
    }
    
    .alert-item.caution {
      border-left-color: #ffeb3b;
      background: rgba(61, 58, 10, 0.8);
    }
    
    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .alert-severity {
      font-weight: 700;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 3px;
    }
    
    .alert-severity.critical {
      background: #f44336;
      color: #fff;
    }
    
    .alert-severity.warning {
      background: #ff9800;
      color: #000;
    }
    
    .alert-severity.caution {
      background: #ffeb3b;
      color: #000;
    }
    
    .alert-aircraft {
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(0, 172, 193, 0.2);
    }
    
    .alert-item.critical .alert-aircraft {
      color: #f44336;
      background: rgba(244, 67, 54, 0.2);
    }
    
    .alert-item.warning .alert-aircraft {
      color: #ff9800;
      background: rgba(255, 152, 0, 0.2);
    }
    
    .alert-item.caution .alert-aircraft {
      color: #ffeb3b;
      background: rgba(255, 235, 59, 0.2);
    }
    
    .alert-details {
      color: #aaa;
      font-size: 11px;
      margin-top: 8px;
      line-height: 1.5;
    }
    
    .alert-time {
      color: #f44336;
      font-weight: 700;
      font-size: 14px;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-left: 10px;
      animation: pulse 2s infinite;
    }
    
    .status-indicator.live {
      background: #4caf50;
    }
    
    .status-indicator.fallback {
      background: #ff9800;
    }
    
    .status-indicator.error {
      background: #f44336;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes conflictFlash {
      0%, 100% { 
        filter: drop-shadow(0 0 8px #f44336);
        opacity: 1;
      }
      50% { 
        filter: drop-shadow(0 0 16px #f44336);
        opacity: 0.7;
      }
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(15, 15, 35, 0.5);
    }
    
    ::-webkit-scrollbar-thumb {
      background: #00acc1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #00d4e8;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="header">
      <div>
        <h1>‚ö° ATC FLOW MANAGEMENT PLATFORM</h1>
        <div id="header-subtitle">
          <span id="status-text">System Online</span>
          <span id="status-indicator" class="status-indicator live"></span>
        </div>
      </div>
      <div id="header-controls">
        <div id="mode-tabs">
          <button class="mode-tab active" onclick="switchMode('live')">üì° LIVE FEED</button>
          <button class="mode-tab" onclick="switchMode('simulation')">üéÆ SIMULATION</button>
        </div>
        <div id="facility-select">
          <select id="airport" onchange="changeFacility()">
            <option value="KSFO">KSFO - San Francisco</option>
            <option value="KLAX">KLAX - Los Angeles</option>
            <option value="KSJC">KSJC - San Jose</option>
            <option value="KORD">KORD - Chicago O'Hare</option>
            <option value="KJFK">KJFK - New York JFK</option>
          </select>
        </div>
      </div>
    </div>
    
    <div id="map-container">
      <div id="map"></div>
      
      <!-- Live Feed Dashboard -->
      <div id="live-dashboard" class="dashboard active">
        <div id="left-panel">
          <button id="left-panel-toggle" onclick="toggleLeftPanel()">‚óÄ</button>
          
          <div class="panel-section">
            <div class="panel-header">üéØ Active in Sector</div>
            
            <div style="margin-top:12px;">
              <div style="font-size:11px;font-weight:700;color:#4caf50;margin-bottom:6px;">‚¨áÔ∏è INBOUND</div>
              <div id="active-inbound"></div>
            </div>
            
            <div style="margin-top:12px;">
              <div style="font-size:11px;font-weight:700;color:#00acc1;margin-bottom:6px;">‚¨ÜÔ∏è OUTBOUND</div>
              <div id="active-outbound"></div>
            </div>
            
            <div style="margin-top:12px;">
              <div style="font-size:11px;font-weight:700;color:#9c27b0;margin-bottom:6px;">‚ÜîÔ∏è CROSSING</div>
              <div id="active-crossing"></div>
            </div>
          </div>
        </div>
        
        <div id="inbound-alert-box">
          <div class="inbound-header">
            üì° INBOUND TRAFFIC
            <span class="inbound-count" id="inbound-count">0</span>
          </div>
          <div id="inbound-traffic"></div>
        </div>
      </div>
      
      <!-- Simulation Dashboard -->
      <div id="simulation-dashboard" class="dashboard">
        <!-- Simulation Control Bar -->
        <div id="sim-control-bar">
          <button class="control-btn-large" id="sim-toggle" onclick="toggleSimulation()">
            <span id="sim-toggle-icon">‚ñ∂</span>
            <span id="sim-toggle-text">START</span>
          </button>
          
          <div class="sim-stat">
            <div class="sim-stat-label">Aircraft</div>
            <div class="sim-stat-value" id="stat-aircraft">0</div>
          </div>
          
          <div class="sim-stat">
            <div class="sim-stat-label">Conflicts</div>
            <div class="sim-stat-value" id="stat-conflicts" style="color:#4caf50;">0</div>
          </div>
          
          <div class="sim-stat">
            <div class="sim-stat-label">Time</div>
            <div class="sim-stat-value" id="stat-time">00:00</div>
          </div>
          
          <button class="expand-btn" onclick="toggleExpandedControls()">‚öôÔ∏è SETTINGS</button>
        </div>
        
        <!-- Expanded Controls -->
        <div id="sim-controls-expanded">
          <div class="control-group">
            <label class="control-label">Traffic Flow Rate</label>
            <div class="control-value"><span id="flow-rate-value">5</span> aircraft/min</div>
            <input type="range" id="flow-rate-slider" min="1" max="15" value="5" oninput="updateFlowRate(this.value)">
          </div>
          
          <div class="control-group">
            <label class="control-label">Simulation Speed</label>
            <div class="control-value"><span id="speed-value">1</span>x</div>
            <input type="range" id="speed-slider" min="1" max="10" value="1" oninput="updateSpeed(this.value)">
          </div>
          
          <div class="control-group">
            <label class="control-label">Conflict Sensitivity</label>
            <div class="control-value"><span id="sensitivity-value">5</span> nm</div>
            <input type="range" id="sensitivity-slider" min="3" max="10" value="5" step="0.5" oninput="updateSensitivity(this.value)">
          </div>
          
          <button class="btn btn-danger" onclick="resetSimulation()">RESET SIMULATION</button>
        </div>
        
        <!-- Keep Traffic Panels -->
        <div id="left-panel">
          <button id="left-panel-toggle" onclick="toggleLeftPanel()">‚óÄ</button>
          
          <div class="panel-section">
            <div class="panel-header">üéØ Active in Sector</div>
            
            <div style="margin-top:12px;">
              <div style="font-size:11px;font-weight:700;color:#4caf50;margin-bottom:6px;">‚¨áÔ∏è INBOUND</div>
              <div id="sim-active-inbound"></div>
            </div>
            
            <div style="margin-top:12px;">
              <div style="font-size:11px;font-weight:700;color:#00acc1;margin-bottom:6px;">‚¨ÜÔ∏è OUTBOUND</div>
              <div id="sim-active-outbound"></div>
            </div>
            
            <div style="margin-top:12px;">
              <div style="font-size:11px;font-weight:700;color:#9c27b0;margin-bottom:6px;">‚ÜîÔ∏è CROSSING</div>
              <div id="sim-active-crossing"></div>
            </div>
          </div>
        </div>
        
        <div id="inbound-alert-box">
          <div class="inbound-header">
            üì° INBOUND TRAFFIC
            <span class="inbound-count" id="sim-inbound-count">0</span>
          </div>
          <div id="sim-inbound-traffic"></div>
        </div>
      </div>
      
      <!-- Conflict Panel - Right Side (Shared) -->
      <div id="conflict-panel">
        <div id="conflict-panel-header">
          <div id="conflict-panel-title">üö® CONFLICT ALERTS</div>
          <button class="panel-toggle-btn" onclick="toggleConflictPanel()">HIDE</button>
        </div>
        <div id="conflict-panel-content">
          <div class="alert-summary">
            <div class="alert-count">
              <div class="alert-count-value critical" id="critical-count">0</div>
              <div class="alert-count-label">Critical</div>
            </div>
            <div class="alert-count">
              <div class="alert-count-value warning" id="warning-count">0</div>
              <div class="alert-count-label">Warning</div>
            </div>
            <div class="alert-count">
              <div class="alert-count-value caution" id="caution-count">0</div>
              <div class="alert-count-label">Caution</div>
            </div>
          </div>
          <div id="alerts-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, sectorCircle, trafficMarkers = [];
    let currentFacility = 'KSFO';
    let sectorRadius = 50;
    let currentMode = 'live';
    let conflictPanelHidden = false;
    let leftPanelCollapsed = false;
    let expandedControlsVisible = false;
    
    // Live Feed Variables
    let liveTraffic = [];
    let lastSeenAircraft = new Map();
    let apiFailCount = 0;
    let useFallback = false;
    let liveUpdateInterval = null;
    let liveConflictInterval = null;
    
    // Simulation Variables
    let simulatedTraffic = [];
    let simulationRunning = false;
    let simulationSpeed = 1;
    let trafficFlowRate = 5; // aircraft per minute
    let conflictSensitivity = 5;
    let simulationStartTime = 0;
    let simulationElapsedTime = 0;
    let totalConflictsDetected = 0;
    let nextAircraftId = 0;
    let lastSpawnTime = 0;
    
    const facilities = {
      KSFO: {pos: [37.6213, -122.3789], radius: 50, name: 'San Francisco'},
      KLAX: {pos: [33.9425, -118.4081], radius: 60, name: 'Los Angeles'},
      KSJC: {pos: [37.3639, -121.9289], radius: 30, name: 'San Jose'},
      KORD: {pos: [41.9742, -87.9073], radius: 70, name: 'Chicago'},
      KJFK: {pos: [40.6413, -73.7781], radius: 60, name: 'New York'}
    };

    const callsignPrefixes = ['UAL', 'DAL', 'SWA', 'AAL', 'JBU', 'SKW', 'FFT', 'ASA', 'NKS', 'FDX', 'UPS', 'N'];

    document.addEventListener('DOMContentLoaded', () => {
      map = L.map('map').setView(facilities[currentFacility].pos, 9);
      
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap, ¬© CARTO'
      }).addTo(map);

      drawSectorBoundary();
      startLiveMode();
    });

    function switchMode(mode) {
      if (currentMode === mode) return;
      
      currentMode = mode;
      
      document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      trafficMarkers.forEach(m => map.removeLayer(m));
      trafficMarkers = [];
      
      if (mode === 'live') {
        document.getElementById('live-dashboard').classList.add('active');
        document.getElementById('simulation-dashboard').classList.remove('active');
        stopSimulationMode();
        startLiveMode();
      } else {
        document.getElementById('simulation-dashboard').classList.add('active');
        document.getElementById('live-dashboard').classList.remove('active');
        stopLiveMode();
        startSimulationMode();
      }
    }

    function toggleExpandedControls() {
      expandedControlsVisible = !expandedControlsVisible;
      const panel = document.getElementById('sim-controls-expanded');
      if (expandedControlsVisible) {
        panel.classList.add('visible');
      } else {
        panel.classList.remove('visible');
      }
    }

    function toggleConflictPanel() {
      conflictPanelHidden = !conflictPanelHidden;
      const panel = document.getElementById('conflict-panel');
      if (conflictPanelHidden) {
        panel.classList.add('hidden');
      } else {
        panel.classList.remove('hidden');
      }
    }

    function toggleLeftPanel() {
      const panel = document.getElementById('left-panel');
      const toggle = document.getElementById('left-panel-toggle');
      leftPanelCollapsed = !leftPanelCollapsed;
      
      if (leftPanelCollapsed) {
        panel.classList.add('collapsed');
        toggle.textContent = '‚ñ∂';
      } else {
        panel.classList.remove('collapsed');
        toggle.textContent = '‚óÄ';
      }
    }

    function updateFlowRate(value) {
      trafficFlowRate = parseInt(value);
      document.getElementById('flow-rate-value').textContent = trafficFlowRate;
    }

    function updateSpeed(value) {
      simulationSpeed = parseInt(value);
      document.getElementById('speed-value').textContent = simulationSpeed;
    }

    function updateSensitivity(value) {
      conflictSensitivity = parseFloat(value);
      document.getElementById('sensitivity-value').textContent = conflictSensitivity;
    }

    function startLiveMode() {
      updateStatus('live', 'Initializing Live Feed...');
      loadLiveTraffic();
      liveUpdateInterval = setInterval(loadLiveTraffic, 45000);
      liveConflictInterval = setInterval(detectLiveConflicts, 5000);
    }

    function stopLiveMode() {
      if (liveUpdateInterval) clearInterval(liveUpdateInterval);
      if (liveConflictInterval) clearInterval(liveConflictInterval);
      liveTraffic = [];
    }

    function startSimulationMode() {
      updateStatus('live', 'Simulation Mode Ready');
      simulatedTraffic = [];
      nextAircraftId = 0;
      lastSpawnTime = 0;
    }

    function stopSimulationMode() {
      if (simulationRunning) {
        simulationRunning = false;
        updateSimToggleButton(false);
      }
      simulatedTraffic = [];
    }

    function toggleSimulation() {
      simulationRunning = !simulationRunning;
      updateSimToggleButton(simulationRunning);
      
      if (simulationRunning) {
        simulationStartTime = Date.now() - (simulationElapsedTime * 1000);
        lastSpawnTime = Date.now();
        runSimulation();
      }
    }

    function updateSimToggleButton(isRunning) {
      const btn = document.getElementById('sim-toggle');
      const icon = document.getElementById('sim-toggle-icon');
      const text = document.getElementById('sim-toggle-text');
      
      if (isRunning) {
        btn.classList.add('playing');
        icon.textContent = '‚è∏';
        text.textContent = 'PAUSE';
      } else {
        btn.classList.remove('playing');
        icon.textContent = '‚ñ∂';
        text.textContent = 'START';
      }
    }

    function resetSimulation() {
      simulationRunning = false;
      updateSimToggleButton(false);
      simulationElapsedTime = 0;
      totalConflictsDetected = 0;
      nextAircraftId = 0;
      lastSpawnTime = 0;
      
      trafficMarkers.forEach(m => map.removeLayer(m));
      trafficMarkers = [];
      simulatedTraffic = [];
      
      document.getElementById('stat-time').textContent = '00:00';
      updateSimStats();
      updateSimTrafficDisplay();
    }

    function runSimulation() {
      if (!simulationRunning) return;
      
      const currentTime = Date.now();
      simulationElapsedTime = (currentTime - simulationStartTime) / 1000;
      
      // Update time display
      const minutes = Math.floor(simulationElapsedTime / 60);
      const seconds = Math.floor(simulationElapsedTime % 60);
      document.getElementById('stat-time').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Spawn new aircraft based on flow rate
      const spawnInterval = (60 / trafficFlowRate) * 1000; // milliseconds
      if (currentTime - lastSpawnTime >= spawnInterval) {
        spawnNewAircraft();
        lastSpawnTime = currentTime;
      }
      
      // Update existing aircraft
      const timeStep = 0.1 * simulationSpeed;
      
      simulatedTraffic.forEach((aircraft, index) => {
        // Move aircraft
        const distanceNM = (aircraft.speed / 3600) * timeStep;
        const newPos = calculateEndPoint(aircraft.lat, aircraft.lon, aircraft.heading, distanceNM);
        aircraft.lat = newPos[0];
        aircraft.lon = newPos[1];
        
        // Update altitude
        if (aircraft.climbRate !== 0) {
          aircraft.altitude += aircraft.climbRate * timeStep / 60;
          
          if ((aircraft.climbRate > 0 && aircraft.altitude >= aircraft.targetAltitude) ||
              (aircraft.climbRate < 0 && aircraft.altitude <= aircraft.targetAltitude)) {
            aircraft.altitude = aircraft.targetAltitude;
            aircraft.climbRate = 0;
          }
        }
        
        // Update heading
        if (Math.abs(aircraft.heading - aircraft.targetHeading) > 1) {
          let headingDiff = aircraft.targetHeading - aircraft.heading;
          if (headingDiff > 180) headingDiff -= 360;
          if (headingDiff < -180) headingDiff += 360;
          
          const turnRate = 3;
          const turnAmount = Math.sign(headingDiff) * Math.min(Math.abs(headingDiff), turnRate * timeStep);
          aircraft.heading = (aircraft.heading + turnAmount + 360) % 360;
        }
        
        // Remove aircraft that left sector
        const facility = facilities[currentFacility];
        const dist = calculateDistance(facility.pos[0], facility.pos[1], aircraft.lat, aircraft.lon);
        
        if (dist > sectorRadius * 1.5) {
          // Remove aircraft
          const marker = trafficMarkers.find(m => m.aircraftId === aircraft.id);
          if (marker) {
            map.removeLayer(marker);
            const markerIndex = trafficMarkers.indexOf(marker);
            if (markerIndex > -1) trafficMarkers.splice(markerIndex, 1);
          }
          simulatedTraffic.splice(index, 1);
        } else {
          updateSimulatedAircraftMarker(aircraft);
        }
      });
      
      detectSimulationConflicts();
      updateSimStats();
      updateSimTrafficDisplay();
      
      setTimeout(runSimulation, 100);
    }

    function spawnNewAircraft() {
      const facility = facilities[currentFacility];
      
      // Spawn outside sector boundary
      const angle = Math.random() * 360;
      const spawnDistance = sectorRadius * 1.3;
      
      const lat = facility.pos[0] + (spawnDistance / 60) * Math.cos(angle * Math.PI / 180);
      const lon = facility.pos[1] + (spawnDistance / 60) * Math.sin(angle * Math.PI / 180) / Math.cos(facility.pos[0] * Math.PI / 180);
      
      const altitude = (Math.floor(Math.random() * 36) + 5) * 1000;
      const speed = 180 + Math.random() * 200 + (altitude / 1000) * 3;
      
      // Determine if inbound, outbound, or crossing
      const trafficPattern = Math.random();
      let heading;
      
      if (trafficPattern < 0.5) {
        // Inbound - heading towards facility
        const bearingToFacility = calculateBearing(lat, lon, facility.pos[0], facility.pos[1]);
        heading = bearingToFacility + (Math.random() - 0.5) * 20;
      } else if (trafficPattern < 0.7) {
        // Outbound - heading away from facility
        const bearingFromFacility = calculateBearing(facility.pos[0], facility.pos[1], lat, lon);
        heading = bearingFromFacility + (Math.random() - 0.5) * 20;
      } else {
        // Crossing - perpendicular to radial
        const radialHeading = calculateBearing(facility.pos[0], facility.pos[1], lat, lon);
        heading = (radialHeading + 90 + (Math.random() - 0.5) * 40) % 360;
      }
      
      heading = (heading + 360) % 360;
      
      const prefix = callsignPrefixes[Math.floor(Math.random() * callsignPrefixes.length)];
      const number = Math.floor(Math.random() * 900) + 100;
      
      const aircraft = {
        id: 'SIM' + nextAircraftId++,
        callsign: prefix + number,
        lat: lat,
        lon: lon,
        altitude: altitude,
        speed: Math.round(speed),
        heading: Math.round(heading),
        targetAltitude: altitude,
        targetHeading: heading,
        climbRate: 0
      };
      
      simulatedTraffic.push(aircraft);
      addSimulatedAircraftMarker(aircraft);
    }

    function updateSimStats() {
      document.getElementById('stat-aircraft').textContent = simulatedTraffic.length;
      
      const conflictEl = document.getElementById('stat-conflicts');
      conflictEl.textContent = totalConflictsDetected;
      
      if (totalConflictsDetected === 0) {
        conflictEl.style.color = '#4caf50';
      } else if (totalConflictsDetected < 3) {
        conflictEl.style.color = '#ffeb3b';
      } else {
        conflictEl.style.color = '#f44336';
      }
    }

    function updateSimTrafficDisplay() {
      const facility = facilities[currentFacility];
      const activeTraffic = simulatedTraffic.filter(ac => {
        const dist = calculateDistance(facility.pos[0], facility.pos[1], ac.lat, ac.lon);
        return dist <= sectorRadius;
      });
      
      const inbound = [];
      const outbound = [];
      const crossing = [];
      
      activeTraffic.forEach(ac => {
        const bearingToFacility = calculateBearing(ac.lat, ac.lon, facility.pos[0], facility.pos[1]);
        const bearingFromFacility = calculateBearing(facility.pos[0], facility.pos[1], ac.lat, ac.lon);
        
        const headingToFacilityDiff = Math.abs(ac.heading - bearingToFacility);
        const headingFromFacilityDiff = Math.abs(ac.heading - bearingFromFacility);
        
        const normalizedToFacility = headingToFacilityDiff > 180 ? 360 - headingToFacilityDiff : headingToFacilityDiff;
        const normalizedFromFacility = headingFromFacilityDiff > 180 ? 360 - headingFromFacilityDiff : headingFromFacilityDiff;
        
        const dist = calculateDistance(facility.pos[0], facility.pos[1], ac.lat, ac.lon);
        
        if (normalizedToFacility < 45) {
          inbound.push({...ac, distance: dist});
        } else if (normalizedFromFacility < 45) {
          outbound.push({...ac, distance: dist});
        } else {
          crossing.push({...ac, distance: dist});
        }
      });
      
      inbound.sort((a, b) => a.distance - b.distance);
      outbound.sort((a, b) => a.distance - b.distance);
      crossing.sort((a, b) => a.distance - b.distance);
      
      // Update displays
      document.getElementById('sim-active-inbound').innerHTML = inbound.length === 0 ? 
        '<div class="empty-state">No inbound</div>' :
        inbound.map(ac => `
          <div class="traffic-item inbound-item">
            <div class="traffic-callsign">${ac.callsign}</div>
            <div class="traffic-details">
              ${Math.round(ac.altitude).toLocaleString()}ft | ${Math.round(ac.heading)}¬∞ | ${ac.distance.toFixed(1)}nm
            </div>
          </div>
        `).join('');
      
      document.getElementById('sim-active-outbound').innerHTML = outbound.length === 0 ?
        '<div class="empty-state">No outbound</div>' :
        outbound.map(ac => `
          <div class="traffic-item outbound-item">
            <div class="traffic-callsign">${ac.callsign}</div>
            <div class="traffic-details">
              ${Math.round(ac.altitude).toLocaleString()}ft | ${Math.round(ac.heading)}¬∞ | ${ac.distance.toFixed(1)}nm
            </div>
          </div>
        `).join('');
      
      document.getElementById('sim-active-crossing').innerHTML = crossing.length === 0 ?
        '<div class="empty-state">No crossing</div>' :
        crossing.map(ac => `
          <div class="traffic-item crossing-item">
            <div class="traffic-callsign">${ac.callsign}</div>
            <div class="traffic-details">
              ${Math.round(ac.altitude).toLocaleString()}ft | ${Math.round(ac.heading)}¬∞ | ${ac.distance.toFixed(1)}nm
            </div>
          </div>
        `).join('');
      
      // Inbound predictions
      const inboundPredictions = predictSimInbound();
      document.getElementById('sim-inbound-count').textContent = inboundPredictions.length;
      
      const inboundBox = document.getElementById('inbound-alert-box');
      if (inboundPredictions.length === 0) {
        inboundBox.classList.add('empty');
      } else {
        inboundBox.classList.remove('empty');
        document.getElementById('sim-inbound-traffic').innerHTML = inboundPredictions.map(ac => `
          <div class="traffic-item">
            <div class="traffic-callsign">${ac.callsign}</div>
            <div class="traffic-details">
              ${Math.round(ac.altitude).toLocaleString()}ft | ETA: ${ac.eta}min | ${ac.distance.toFixed(1)}nm
            </div>
          </div>
        `).join('');
      }
    }

    function predictSimInbound() {
      const facility = facilities[currentFacility];
      const inbound = [];
      
      simulatedTraffic.forEach(ac => {
        const dist = calculateDistance(facility.pos[0], facility.pos[1], ac.lat, ac.lon);
        
        if (dist > sectorRadius && dist < sectorRadius * 1.5) {
          const bearingToFacility = calculateBearing(ac.lat, ac.lon, facility.pos[0], facility.pos[1]);
          const headingDiff = Math.abs(ac.heading - bearingToFacility);
          const normalizedDiff = headingDiff > 180 ? 360 - headingDiff : headingDiff;
          
          if (normalizedDiff < 60 && ac.speed > 0) {
            const distToEnter = dist - sectorRadius;
            const eta = Math.round((distToEnter / ac.speed) * 60);
            
            if (eta <= 15) {
              inbound.push({...ac, eta: eta, distance: dist});
            }
          }
        }
      });
      
      return inbound.sort((a, b) => a.eta - b.eta);
    }

    // Placeholder functions for live mode (keeping original implementations)
    async function loadLiveTraffic() {
      // Original live traffic loading code here
      // Keeping fallback for now
      loadFallbackTraffic();
      updateLiveTrafficDisplay();
    }

    function loadFallbackTraffic() {
      const facility = facilities[currentFacility];
      
      const fallback = [
        { callsign: 'UAL123', offset: [0.15, -0.10], altitude: 8000, speed: 250, heading: 180 },
        { callsign: 'SWA456', offset: [-0.20, 0.08], altitude: 12000, speed: 280, heading: 270 },
        { callsign: 'AAL789', offset: [0.25, 0.15], altitude: 15000, speed: 320, heading: 45 }
      ];
      
      fallback.forEach(ac => {
        const lat = facility.pos[0] + ac.offset[0];
        const lon = facility.pos[1] + ac.offset[1];
        const dist = calculateDistance(facility.pos[0], facility.pos[1], lat, lon);
        
        const bearingToFacility = calculateBearing(lat, lon, facility.pos[0], facility.pos[1]);
        const headingToFacilityDiff = Math.abs(ac.heading - bearingToFacility);
        const normalizedToFacility = headingToFacilityDiff > 180 ? 360 - headingToFacilityDiff : headingToFacilityDiff;
        
        let trafficType = normalizedToFacility < 45 ? 'inbound' : 'crossing';
        
        const aircraft = {
          icao24: 'SIM' + ac.callsign,
          callsign: ac.callsign,
          lat: lat,
          lon: lon,
          altitude: ac.altitude,
          speed: ac.speed,
          heading: ac.heading,
          distance: dist,
          trafficType: trafficType,
          lastSeen: Date.now()
        };
        
        liveTraffic.push(aircraft);
        addLiveAircraftMarker(aircraft);
      });
    }

    function addLiveAircraftMarker(aircraft) {
      let triangleColor;
      if (aircraft.trafficType === 'inbound') {
        triangleColor = '#4caf50';
      } else if (aircraft.trafficType === 'outbound') {
        triangleColor = '#00acc1';
      } else {
        triangleColor = '#9c27b0';
      }
      
      const arrowIcon = L.divIcon({
        html: `<div style="transform:rotate(${aircraft.heading}deg);color:${triangleColor};font-size:24px;text-shadow:0 0 3px #000;">‚ñ≤</div>`,
        className: '',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
      
      const marker = L.marker([aircraft.lat, aircraft.lon], {
        icon: arrowIcon
      }).addTo(map).bindPopup(
        `<b>${aircraft.callsign}</b><br>` +
        `Type: ${aircraft.trafficType.toUpperCase()}<br>` +
        `Alt: ${aircraft.altitude.toLocaleString()} ft<br>` +
        `Speed: ${aircraft.speed} kts<br>` +
        `Heading: ${Math.round(aircraft.heading)}¬∞`
      );
      
      trafficMarkers.push(marker);
    }

    function updateLiveTrafficDisplay() {
      // Simple placeholder
      document.getElementById('active-inbound').innerHTML = '<div class="empty-state">Live mode</div>';
      document.getElementById('active-outbound').innerHTML = '<div class="empty-state">Live mode</div>';
      document.getElementById('active-crossing').innerHTML = '<div class="empty-state">Live mode</div>';
    }

    function detectLiveConflicts() {
      // Placeholder
      displayAlerts([]);
    }

    function addSimulatedAircraftMarker(aircraft) {
      const facility = facilities[currentFacility];
      const dist = calculateDistance(facility.pos[0], facility.pos[1], aircraft.lat, aircraft.lon);
      
      const bearingToFacility = calculateBearing(aircraft.lat, aircraft.lon, facility.pos[0], facility.pos[1]);
      const bearingFromFacility = calculateBearing(facility.pos[0], facility.pos[1], aircraft.lat, aircraft.lon);
      
      const headingToFacilityDiff = Math.abs(aircraft.heading - bearingToFacility);
      const headingFromFacilityDiff = Math.abs(aircraft.heading - bearingFromFacility);
      
      const normalizedToFacility = headingToFacilityDiff > 180 ? 360 - headingToFacilityDiff : headingToFacilityDiff;
      const normalizedFromFacility = headingFromFacilityDiff > 180 ? 360 - headingFromFacilityDiff : headingFromFacilityDiff;
      
      let triangleColor;
      if (normalizedToFacility < 45) {
        triangleColor = '#4caf50';
      } else if (normalizedFromFacility < 45) {
        triangleColor = '#00acc1';
      } else {
        triangleColor = '#9c27b0';
      }
      
      const arrowIcon = L.divIcon({
        html: `<div style="transform:rotate(${aircraft.heading}deg);color:${triangleColor};font-size:20px;text-shadow:0 0 3px #000;">‚ñ≤</div>`,
        className: '',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      
      const marker = L.marker([aircraft.lat, aircraft.lon], {
        icon: arrowIcon
      }).addTo(map).bindPopup(
        `<b>${aircraft.callsign}</b><br>` +
        `Alt: ${Math.round(aircraft.altitude).toLocaleString()} ft<br>` +
        `Speed: ${aircraft.speed} kts<br>` +
        `Heading: ${Math.round(aircraft.heading)}¬∞<br>` +
        `Distance: ${dist.toFixed(1)} nm`
      );
      
      marker.aircraftId = aircraft.id;
      trafficMarkers.push(marker);
    }

    function updateSimulatedAircraftMarker(aircraft) {
      const marker = trafficMarkers.find(m => m.aircraftId === aircraft.id);
      if (marker) {
        marker.setLatLng([aircraft.lat, aircraft.lon]);
        
        const facility = facilities[currentFacility];
        const dist = calculateDistance(facility.pos[0], facility.pos[1], aircraft.lat, aircraft.lon);
        
        const bearingToFacility = calculateBearing(aircraft.lat, aircraft.lon, facility.pos[0], facility.pos[1]);
        const bearingFromFacility = calculateBearing(facility.pos[0], facility.pos[1], aircraft.lat, aircraft.lon);
        
        const headingToFacilityDiff = Math.abs(aircraft.heading - bearingToFacility);
        const headingFromFacilityDiff = Math.abs(aircraft.heading - bearingFromFacility);
        
        const normalizedToFacility = headingToFacilityDiff > 180 ? 360 - headingToFacilityDiff : headingToFacilityDiff;
        const normalizedFromFacility = headingFromFacilityDiff > 180 ? 360 - headingFromFacilityDiff : headingFromFacilityDiff;
        
        let triangleColor;
        if (normalizedToFacility < 45) {
          triangleColor = '#4caf50';
        } else if (normalizedFromFacility < 45) {
          triangleColor = '#00acc1';
        } else {
          triangleColor = '#9c27b0';
        }
        
        const arrowIcon = L.divIcon({
          html: `<div style="transform:rotate(${aircraft.heading}deg);color:${triangleColor};font-size:20px;text-shadow:0 0 3px #000;">‚ñ≤</div>`,
          className: '',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });
        
        marker.setIcon(arrowIcon);
        
        marker.setPopupContent(
          `<b>${aircraft.callsign}</b><br>` +
          `Alt: ${Math.round(aircraft.altitude).toLocaleString()} ft<br>` +
          `Speed: ${aircraft.speed} kts<br>` +
          `Heading: ${Math.round(aircraft.heading)}¬∞<br>` +
          `Distance: ${dist.toFixed(1)} nm`
        );
      }
    }

    function detectSimulationConflicts() {
      if (currentMode !== 'simulation') return;
      
      const alerts = [];
      const activeTraffic = simulatedTraffic.filter(ac => {
        const facility = facilities[currentFacility];
        const dist = calculateDistance(facility.pos[0], facility.pos[1], ac.lat, ac.lon);
        return dist <= sectorRadius;
      });
      
      for (let i = 0; i < activeTraffic.length; i++) {
        for (let j = i + 1; j < activeTraffic.length; j++) {
          const ac1 = activeTraffic[i];
          const ac2 = activeTraffic[j];
          
          for (let minutes = 1; minutes <= 10; minutes++) {
            const pos1 = predictPosition(ac1, minutes);
            const pos2 = predictPosition(ac2, minutes);
            
            const futureDistance = calculateDistance(pos1.lat, pos1.lon, pos2.lat, pos2.lon);
            const altSeparation = Math.abs(pos1.alt - pos2.alt);
            
            if (futureDistance < conflictSensitivity && altSeparation < 1000) {
              const existingAlert = alerts.find(a => 
                (a.aircraft1 === ac1.callsign && a.aircraft2 === ac2.callsign) ||
                (a.aircraft1 === ac2.callsign && a.aircraft2 === ac1.callsign)
              );
              
              if (!existingAlert) {
                let severity;
                if (minutes <= 3) {
                  severity = 'critical';
                } else if (minutes <= 5) {
                  severity = 'warning';
                } else {
                  severity = 'caution';
                }
                
                alerts.push({
                  aircraft1: ac1.callsign,
                  aircraft2: ac2.callsign,
                  alt1: Math.round(ac1.altitude),
                  alt2: Math.round(ac2.altitude),
                  timeToConflict: minutes,
                  predictedDistance: futureDistance,
                  altSeparation: altSeparation,
                  severity: severity
                });
              }
              
              break;
            }
          }
        }
      }
      
      totalConflictsDetected = alerts.length;
      displayAlerts(alerts);
    }

    function predictPosition(aircraft, minutes) {
      if (!aircraft.speed || aircraft.speed < 50) {
        return {
          lat: aircraft.lat,
          lon: aircraft.lon,
          alt: aircraft.altitude
        };
      }
      
      const distanceNM = (aircraft.speed / 60) * minutes;
      const newPos = calculateEndPoint(aircraft.lat, aircraft.lon, aircraft.heading, distanceNM);
      
      let predictedAlt = aircraft.altitude;
      if (aircraft.climbRate !== 0) {
        predictedAlt += aircraft.climbRate * minutes;
        predictedAlt = Math.max(aircraft.altitude, Math.min(aircraft.targetAltitude || aircraft.altitude, predictedAlt));
      }
      
      return {
        lat: newPos[0],
        lon: newPos[1],
        alt: predictedAlt
      };
    }

    function displayAlerts(alerts) {
      const alertsList = document.getElementById('alerts-list');
      const panelHeader = document.getElementById('conflict-panel-header');
      
      const critical = alerts.filter(a => a.severity === 'critical').length;
      const warning = alerts.filter(a => a.severity === 'warning').length;
      const caution = alerts.filter(a => a.severity === 'caution').length;
      
      document.getElementById('critical-count').textContent = critical;
      document.getElementById('warning-count').textContent = warning;
      document.getElementById('caution-count').textContent = caution;
      
      if (alerts.length === 0) {
        alertsList.innerHTML = '<div class="empty-state" style="color:#4caf50;">‚úÖ No conflicts detected<br>All aircraft safely separated</div>';
        panelHeader.classList.remove('has-alerts');
        return;
      }
      
      panelHeader.classList.add('has-alerts');
      
      alerts.sort((a, b) => a.timeToConflict - b.timeToConflict);
      
      alertsList.innerHTML = alerts.map(alert => `
        <div class="alert-item ${alert.severity}">
          <div class="alert-header">
            <span class="alert-severity ${alert.severity}">${alert.severity.toUpperCase()}</span>
            <span class="alert-time">‚è±Ô∏è ${alert.timeToConflict} min</span>
          </div>
          <div style="margin:8px 0;">
            <span class="alert-aircraft">${alert.aircraft1}</span>
            <span style="color:#666;"> ‚Üî </span>
            <span class="alert-aircraft">${alert.aircraft2}</span>
          </div>
          <div class="alert-details">
            üìè Separation: ${alert.predictedDistance.toFixed(1)} nm<br>
            üìä Altitude diff: ${Math.round(alert.altSeparation).toLocaleString()} ft<br>
            ‚úàÔ∏è ${alert.alt1.toLocaleString()} ft | ${alert.alt2.toLocaleString()} ft
          </div>
        </div>
      `).join('');
    }

    function changeFacility() {
      currentFacility = document.getElementById('airport').value;
      const facility = facilities[currentFacility];
      sectorRadius = facility.radius;
      map.setView(facility.pos, 9);
      drawSectorBoundary();
      
      trafficMarkers.forEach(m => map.removeLayer(m));
      trafficMarkers = [];
      
      if (currentMode === 'live') {
        liveTraffic = [];
        loadLiveTraffic();
      } else {
        if (simulationRunning) resetSimulation();
      }
    }

    function drawSectorBoundary() {
      if (sectorCircle) map.removeLayer(sectorCircle);
      
      const facility = facilities[currentFacility];
      sectorCircle = L.circle(facility.pos, {
        radius: sectorRadius * 1852,
        color: '#00acc1',
        fillColor: '#00acc1',
        fillOpacity: 0.1,
        weight: 2,
        dashArray: '10, 10'
      }).addTo(map);
      
      L.marker(facility.pos, {
        icon: L.divIcon({
          html: '<div style="background:#00acc1;color:#000;padding:5px 10px;border-radius:5px;font-weight:700;">' + currentFacility + '</div>',
          className: ''
        })
      }).addTo(map);
    }

    function updateStatus(type, message) {
      const statusText = document.getElementById('status-text');
      const statusIndicator = document.getElementById('status-indicator');
      
      statusText.textContent = message;
      statusIndicator.className = 'status-indicator ' + type;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3440.065;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
      const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
      let bearing = Math.atan2(y, x) * 180 / Math.PI;
      return (bearing + 360) % 360;
    }
    
    function calculateEndPoint(lat1, lon1, bearing, distanceNM) {
      const R = 3440.065;
      const d = distanceNM / R;
      const brng = bearing * Math.PI / 180;
      const lat1Rad = lat1 * Math.PI / 180;
      const lon1Rad = lon1 * Math.PI / 180;
      
      const lat2 = Math.asin(
        Math.sin(lat1Rad) * Math.cos(d) +
        Math.cos(lat1Rad) * Math.sin(d) * Math.cos(brng)
      );
      
      const lon2 = lon1Rad + Math.atan2(
        Math.sin(brng) * Math.sin(d) * Math.cos(lat1Rad),
        Math.cos(d) - Math.sin(lat1Rad) * Math.sin(lat2)
      );
      
      return [lat2 * 180 / Math.PI, lon2 * 180 / Math.PI];
    }
  </script>
</body>
</html>
